<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coffee Shop — Live Orders Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thin-scrollbar::-webkit-scrollbar { width: 8px; }
    .thin-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 9999px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="flex flex-col gap-4 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight">☕ Coffee Shop — Live Orders</h1>
          <p class="text-slate-500">Track orders in real time. Update status, manage alerts, and get smart suggestions.</p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="addDemoBtn" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow">Add Demo Order</button>
          <button id="seed10Btn" class="px-3 py-2 rounded-xl bg-emerald-100 text-emerald-800 hover:bg-emerald-200">+10 Demo</button>
          <button id="clearBtn" class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 shadow">Clear All</button>
          <label class="px-3 py-2 rounded-xl bg-white shadow cursor-pointer">
            <span class="text-sm text-slate-600">Upload CSV</span>
            <input id="csvInput" type="file" accept=".csv" class="hidden" />
          </label>
          <div class="flex items-center gap-2 bg-white rounded-xl px-3 py-2 shadow">
            <label class="text-sm text-slate-600">Auto‑refresh</label>
            <select id="refreshSelect" class="bg-transparent text-slate-800 text-sm focus:outline-none">
              <option value="0">Off</option>
              <option value="5000">Every 5s</option>
              <option value="10000">Every 10s</option>
              <option value="30000">Every 30s</option>
              <option value="60000">Every 60s</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Import banner (shows CSV validation results) -->
      <div id="importBanner" class="hidden border rounded-xl p-3"></div>
    </header>

    <section id="summaryBar" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6"></section>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Orders</h2>
          <div class="flex items-center gap-2">
            <input id="searchInput" type="text" placeholder="Search by name or item…" class="px-3 py-2 rounded-xl border border-slate-200 bg-white focus:ring-2 focus:ring-emerald-500 focus:outline-none"/>
            <select id="statusFilter" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm">
              <option value="all">All statuses</option>
              <option value="waiting">Waiting</option>
              <option value="in_progress">In Progress</option>
              <option value="ready">Ready</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div id="ordersGrid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </section>

      <aside class="space-y-6">
        <section class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Alerts</h2>
            <button id="dismissAllAlerts" class="text-sm text-slate-500 hover:text-slate-700">Dismiss All</button>
          </div>
          <div id="alertsList" class="space-y-2 max-h-[360px] overflow-auto thin-scrollbar"></div>
        </section>

        <section class="bg-white rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Smart Assistant</h2>
            <button id="refreshTipsBtn" class="text-sm text-emerald-700 hover:underline">Refresh Tips</button>
          </div>
          <ul id="assistantList" class="list-disc pl-5 space-y-2 text-slate-700"></ul>
        </section>
      </aside>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'coffee_shop_orders_v1';
    const STATUS_LABELS = { waiting: 'Waiting', in_progress: 'In Progress', ready: 'Ready', cancelled: 'Cancelled' };

    const fmtCurrency = (n) => new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(n);
    const uid = () => Math.random().toString(36).slice(2, 9);
    const now = () => new Date().toISOString();
    const minutesSince = (iso) => (Date.now() - new Date(iso).getTime()) / 60000;

    const load = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } };
    const save = (orders) => localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));

    let orders = load();
    let refreshTimer = null;

    function computeTotal(items){ return items.reduce((s,it)=> s + (it.price||0)* (it.qty||1),0); }

    function addOrder(order){ order.id = uid(); order.total = computeTotal(order.items); orders.unshift(order); save(orders); renderAll(); }

    function updateStatus(id, newStatus){ const o = orders.find(x=>x.id===id); if(!o) return; o.status = newStatus; if(newStatus==='cancelled') o.cancelled=true; save(orders); renderAll(); }
    function cancelOrder(id){ updateStatus(id,'cancelled'); }
    function removeAll(){ orders=[]; save(orders); renderAll(); }

    function filterOrders(){ const q=document.getElementById('searchInput').value.toLowerCase().trim(); const f=document.getElementById('statusFilter').value; return orders.filter(o=>{ const matchesText=!q||o.customerName.toLowerCase().includes(q)||o.items.some(it=>it.name.toLowerCase().includes(q)); const matchesStatus=f==='all'?true:(f==='cancelled'?o.cancelled:(!o.cancelled&&o.status===f)); return matchesText&&matchesStatus; }); }

    function renderAll(){ renderSummary(); renderOrders(); renderAlerts(); renderAssistant(); }

    function renderSummary(){ const totalOrders=orders.length; const ready=orders.filter(o=>!o.cancelled&&o.status==='ready').length; const pending=orders.filter(o=>!o.cancelled&&(o.status==='waiting'||o.status==='in_progress')).length; const revenue=orders.filter(o=>!o.cancelled).reduce((s,o)=>s+o.total,0); const cards=[ {label:'Total Orders',value:totalOrders},{label:'Ready vs Pending',value:`${ready} / ${pending}`},{label:'Total Revenue',value:fmtCurrency(revenue)},{label:'Avg Wait (min)',value:(orders.length?orders.reduce((s,o)=>s+minutesSince(o.timestamp),0)/orders.length:0).toFixed(1)}]; document.getElementById('summaryBar').innerHTML=cards.map(c=>`<div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-slate-500">${c.label}</div><div class="text-2xl font-semibold mt-1">${c.value}</div></div>`).join(''); }

    function statusBadge(status,cancelled){ if(cancelled) return '<span class="px-2 py-1 rounded-full text-xs bg-rose-100 text-rose-700">Cancelled</span>'; const map={waiting:'bg-amber-100 text-amber-800',in_progress:'bg-sky-100 text-sky-800',ready:'bg-emerald-100 text-emerald-800'}; return `<span class="px-2 py-1 rounded-full text-xs ${map[status]}">${STATUS_LABELS[status]}</span>`; }
    function orderCardHtml(o){ return `<article class="bg-white rounded-2xl shadow p-4"><div class="flex items-start justify-between gap-3"><div><h3 class="text-lg font-semibold">${o.customerName}</h3><div class="text-sm text-slate-500">${new Date(o.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div><div>${statusBadge(o.status,o.cancelled)}</div></div><ul class="mt-3 text-sm space-y-1">${o.items.map(it=>`<li class="flex justify-between"><span>${it.qty||1}× ${it.name}</span></li>`).join('')}</ul><div class="flex items-center justify-between mt-3 pt-3 border-t"><div class="text-slate-600 text-sm">Payment: <span class="font-medium">${o.paymentMethod}</span></div><div class="text-slate-900 font-semibold">${fmtCurrency(o.total)}</div></div><div class="mt-3 flex items-center gap-2"><select id="status-${o.id}" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm ${o.cancelled?'opacity-50 pointer-events-none':''}">${['waiting','in_progress','ready','cancelled'].map(s=>`<option value="${s}" ${o.cancelled?(s==='cancelled'?'selected':''):(o.status===s?'selected':'')}>${STATUS_LABELS[s]}</option>`).join('')}</select><button id="cancel-${o.id}" class="px-3 py-2 rounded-xl border text-sm ${o.cancelled?'opacity-50 pointer-events-none':'text-rose-700 border-rose-200 hover:bg-rose-50'}">Cancel</button></div></article>`; }

    function renderOrders(){ const grid=document.getElementById('ordersGrid'); const list=filterOrders(); if(!list.length){ grid.innerHTML='<div class="col-span-full text-center text-slate-500 bg-white rounded-2xl p-10">No orders yet.</div>'; return; } grid.innerHTML=list.map(orderCardHtml).join(''); for(const o of list){ document.getElementById(`status-${o.id}`).addEventListener('change',e=>updateStatus(o.id,e.target.value)); document.getElementById(`cancel-${o.id}`).addEventListener('click',()=>cancelOrder(o.id)); } }

    function buildAlerts(){ return []; }
    function renderAlerts(){ document.getElementById('alertsList').innerHTML='<div class="text-slate-500 text-sm">Alerts placeholder</div>'; }
    function renderAssistant(){ document.getElementById('assistantList').innerHTML='<li>Assistant placeholder</li>'; }

    // ------- CSV Upload & Validation --------
    const REQUIRED_HEADERS = ['customer_name','items','status','payment_method','timestamp'];
    const STATUS_MAP = new Map([
      ['waiting','waiting'],
      ['in progress','in_progress'],
      ['in_progress','in_progress'],
      ['ready','ready'],
      ['cancelled','cancelled'],
      ['canceled','cancelled']
    ]);
    const PAYMENT_SET = new Set(['cash','card','upi','wallet']);

    function titleCase(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : s; }

    function showBanner(type, html){
      const el = document.getElementById('importBanner');
      const styles = {
        success: 'border-emerald-200 bg-emerald-50 text-emerald-800',
        error: 'border-rose-200 bg-rose-50 text-rose-800',
        warning: 'border-amber-200 bg-amber-50 text-amber-800'
      };
      el.className = `border rounded-xl p-3 ${styles[type]||''}`;
      el.innerHTML = html;
      el.classList.remove('hidden');
    }

    document.getElementById('csvInput').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(evt){
        const text = evt.target.result;
        importCSV(text);
      };
      reader.readAsText(file);
    });

    function parseCSVLine(line){
      const out = []; let cur = ''; let inQuotes = false;
      for (let i=0; i<line.length; i++){
        const ch = line[i];
        if (inQuotes){
          if (ch === '"'){
            if (line[i+1] === '"'){ cur += '"'; i++; } else { inQuotes = false; }
          } else { cur += ch; }
        } else {
          if (ch === ','){ out.push(cur.trim()); cur = ''; }
          else if (ch === '"'){ inQuotes = true; }
          else { cur += ch; }
        }
      }
      out.push(cur.trim());
      return out;
    }

    function csvToRows(text){
      const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l => l.length>0);
      const rows = [];
      for (const line of lines){ rows.push(parseCSVLine(line)); }
      return rows;
    }

    function normalizeTimestamp(s){
      if (!s) return null;
      const trimmed = s.trim();
      // Accept ISO or "YYYY-MM-DD HH:MM" -> convert to ISO-like
      const maybeSpaced = trimmed.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(?::\d{2})?$/);
      const val = maybeSpaced ? trimmed.replace(' ', 'T') : trimmed;
      const d = new Date(val);
      return isNaN(d.getTime()) ? null : d.toISOString();
    }

    function importCSV(text){
      const rows = csvToRows(text);
      if (rows.length < 2){ showBanner('error', '<strong>Import failed:</strong> No data rows found.'); return; }
      const header = rows[0].map(h => h.trim().toLowerCase());

      // Validate headers
      const missing = REQUIRED_HEADERS.filter(h => !header.includes(h));
      if (missing.length){
        showBanner('error', `<strong>Import failed:</strong> Missing required column(s): <em>${missing.join(', ')}</em>.`);
        return;
      }

      const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
      const errors = [];
      let imported = 0;

      for (let r=1; r<rows.length; r++){
        const row = rows[r];
        // Skip empty rows
        if (row.every(cell => !cell || !cell.trim())) continue;

        const rawName = row[idx['customer_name']] || '';
        const rawItems = row[idx['items']] || '';
        const rawStatus = (row[idx['status']]||'').toLowerCase().trim();
        const rawPayment = (row[idx['payment_method']]||'').toLowerCase().trim();
        const rawTs = row[idx['timestamp']] || '';

        // Validate required values
        if (!rawName.trim()) { errors.push(`Row ${r+1}: missing customer_name.`); continue; }
        if (!rawItems.trim()) { errors.push(`Row ${r+1}: missing items.`); continue; }

        const statusNorm = STATUS_MAP.get(rawStatus);
        if (!statusNorm) { errors.push(`Row ${r+1}: invalid status "${rawStatus}".`); continue; }

        if (!PAYMENT_SET.has(rawPayment)) { errors.push(`Row ${r+1}: invalid payment_method "${rawPayment}".`); continue; }

        const tsIso = normalizeTimestamp(rawTs);
        if (!tsIso) { errors.push(`Row ${r+1}: invalid timestamp "${rawTs}".`); continue; }

        // Build items list (comma or semicolon separated)
        const items = rawItems.split(/\s*;|,\s*/).filter(Boolean).map(name=>({ name: name.trim(), qty: 1, price: 0 }));
        if (!items.length) { errors.push(`Row ${r+1}: could not parse items.`); continue; }

        const order = {
          customerName: rawName.trim(),
          items,
          status: statusNorm,
          paymentMethod: titleCase(rawPayment),
          timestamp: tsIso,
          cancelled: statusNorm === 'cancelled'
        };
        addOrder(order); imported++;
      }

      if (imported && errors.length){
        showBanner('warning', `<strong>Imported ${imported}</strong> row(s) with <strong>${errors.length}</strong> issue(s).<div class="mt-2 text-sm">${errors.slice(0,8).map(e=>`• ${e}`).join('<br>')}${errors.length>8?'<br>…':''}</div>`);
      } else if (imported){
        showBanner('success', `<strong>Imported ${imported}</strong> row(s) successfully.`);
      } else {
        showBanner('error', `<strong>Import failed:</strong> No valid rows. <div class="mt-2 text-sm">${errors.slice(0,8).map(e=>`• ${e}`).join('<br>')}${errors.length>8?'<br>…':''}</div>`);
      }
    }

    // ------- Events & init --------
    document.getElementById('addDemoBtn').addEventListener('click',()=>{ addOrder({customerName:'Demo',items:[{name:'Latte',qty:1,price:4}],status:'waiting',paymentMethod:'Card',timestamp:now()}); });
    document.getElementById('seed10Btn').addEventListener('click',()=>{ for(let i=0;i<10;i++) addOrder({customerName:'Demo'+i,items:[{name:'Espresso',qty:1,price:3}],status:'waiting',paymentMethod:'Cash',timestamp:now()}); });
    document.getElementById('clearBtn').addEventListener('click',removeAll);
    document.getElementById('searchInput').addEventListener('input',renderOrders);
    document.getElementById('statusFilter').addEventListener('change',renderOrders);

    renderAll();
  </script>
</body>
</html>
